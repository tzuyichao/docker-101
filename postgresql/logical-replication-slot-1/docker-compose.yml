services:
  primary:
    image: postgres:16
    container_name: pg_primary
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: appdb
    ports:
      - "5432:5432"
    volumes:
      - primary_data:/var/lib/postgresql/data
      - ./primary/00-config.sql:/docker-entrypoint-initdb.d/00-config.sql:ro
      - ./primary/01-hba.sh:/docker-entrypoint-initdb.d/01-hba.sh:ro
    command: >
      postgres
      -c wal_level=logical
      -c max_wal_senders=10
      -c max_replication_slots=10
      -c hot_standby=on
      -c listen_addresses='*'

  standby:
    image: postgres:16
    container_name: pg_standby
    environment:
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"
    depends_on:
      - primary
    volumes:
      - standby_data:/var/lib/postgresql/data
      - ./standby/init-standby.sh:/init-standby.sh:ro
    entrypoint: ["/bin/bash", "/init-standby.sh"]

  subscriber:
    image: postgres:16
    container_name: pg_subscriber
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: subdb
    ports:
      - "5434:5432"
    volumes:
      - subscriber_data:/var/lib/postgresql/data

volumes:
  primary_data:
  standby_data:
  subscriber_data:
